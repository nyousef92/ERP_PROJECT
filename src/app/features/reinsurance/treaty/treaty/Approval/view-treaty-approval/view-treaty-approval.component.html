<div class="bg-surface rounded-lg w-full flex flex-col" *ngIf="treaty; else loading" [formGroup]="form">

    <!-- Header -->
    <div class="sticky top-0 bg-surface border-b border-border px-4 py-3 flex items-center justify-between z-10">
        <h2 class="text-sm font-semibold text-text">Treaty Review &amp; Approval</h2>
    </div>

    <!-- Scrollable Body -->
    <div class="flex-1 overflow-y-auto p-4">
        <div class="space-y-5">

            <!-- Company Information -->
            <div class="space-y-2" formGroupName="companyInfo">
                <h3
                    class="text-[10px] font-semibold uppercase tracking-wide text-text-muted pb-1 border-b border-border">
                    Company Information
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div>
                        <app-input-field label="Company" formControlName="company" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Company ID" formControlName="companyId" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Account No" formControlName="accountNo" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Phone No" formControlName="phoneNo" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Fax" formControlName="fax" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Email" formControlName="email" [disabled]="true" />
                    </div>
                </div>
                <div>
                    <app-input-field label="Address" formControlName="address" [disabled]="true" />
                </div>
            </div>

            <!-- Treaty Details -->
            <div class="space-y-2" formGroupName="treatyDetails">
                <h3
                    class="text-[10px] font-semibold uppercase tracking-wide text-text-muted pb-1 border-b border-border">
                    Treaty Details
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div>
                        <app-input-field label="Treaty Code" formControlName="treatyCode" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Description" formControlName="description" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Treaty Type" formControlName="treatyType" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Treaty Sub Type" formControlName="treatySubType" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Currency" formControlName="currency" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="From Date" formControlName="fromDate" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="To Date" formControlName="toDate" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="LOB" formControlName="lob" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Sub LOB" formControlName="subLob" [disabled]="true" />
                    </div>
                </div>
                <div>
                    <app-input-field label="Comments" formControlName="comments" [disabled]="true" />
                </div>
                <div class="flex items-center gap-2 h-[34px]">
                    <input type="checkbox" id="catastropheCoverage" [checked]="treaty.treatyDetails.catastropheCoverage"
                        disabled class="w-4 h-4 text-primary border-border rounded">
                    <label for="catastropheCoverage" class="text-sm text-text">Catastrophe Coverage</label>
                </div>
            </div>

            <!-- Reinsurer Participation -->
            <div class="space-y-2">
                <h3
                    class="text-[10px] font-semibold uppercase tracking-wide text-text-muted pb-1 border-b border-border">
                    Reinsurer Participation
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs border-collapse">
                        <thead>
                            <tr class="bg-background font-medium text-text">
                                <th class="px-2 py-2 text-left border border-border min-w-[140px]">Company</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[100px]">Capacity</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[70px]">QS%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[90px]">Retention%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[80px]">Signed%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[80px]">Written%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[70px]">Broker%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[60px]">Tax%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[60px]">Comm%</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[120px]">Reason</th>
                                <th class="px-2 py-2 text-left border border-border min-w-[120px]">Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (r of treaty.reinsurerParticipation; track r.company) {
                            <tr class="border-b border-border hover:bg-background transition-colors">
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.company }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.capacity | number }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.qsPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.retentionPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.signedPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.writtenPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.brokerPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.taxPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.commissionPercent }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.reason }}</td>
                                <td class="px-2 py-1.5 border border-border text-text">{{ r.description }}</td>
                            </tr>
                            }
                            @empty {
                            <tr>
                                <td colspan="11" class="px-3 py-4 text-center text-text-muted text-xs">No reinsurer
                                    participation data.</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Submission Information -->
            <div class="space-y-2" formGroupName="submissionInfo">
                <h3
                    class="text-[10px] font-semibold uppercase tracking-wide text-text-muted pb-1 border-b border-border">
                    Submission Information
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <app-input-field label="Submitted By" formControlName="submittedBy" [disabled]="true" />
                    </div>
                    <div>
                        <app-input-field label="Submitted Date" formControlName="submittedDate" [disabled]="true" />
                    </div>
                </div>
            </div>

            <!-- Approval Action -->
            <div class="space-y-2">
                <h3
                    class="text-[10px] font-semibold uppercase tracking-wide text-text-muted pb-1 border-b border-border">
                    Approval Action
                </h3>
                <div>
                    <label class="block text-xs text-text-muted mb-1">Remarks *</label>
                    <textarea rows="4" formControlName="remarks"
                        class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary transition-colors"
                        placeholder="Enter your remarks for approval or rejection..."></textarea>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer Actions -->
    <div
        class="px-4 py-3 border-t border-border flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-2 sm:gap-3 flex-shrink-0 bg-background sticky bottom-0 z-10">
        <button (click)="onClose()"
            class="px-4 py-2 border border-border rounded-lg text-text hover:bg-surface transition-colors text-sm order-last sm:order-first">
            Close
        </button>
        <button (click)="onReject()"
            class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger-dark transition-colors text-sm">
            Reject
        </button>
        <button (click)="onApprove()"
            class="px-4 py-2 bg-success text-white rounded-lg hover:bg-success-dark transition-colors text-sm">
            Approve
        </button>
    </div>

</div>

<!-- Loading state -->
<ng-template #loading>
    <div class="p-8 text-center text-text-muted">
        <span class="material-icons text-[40px] block mb-2 animate-spin opacity-40">sync</span>
        Loading...
    </div>
</ng-template>
